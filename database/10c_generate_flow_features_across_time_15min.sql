--- Adds new columns to the flow features table that aggregates features from 15 min to 1 hour

--- Schema: features_speedflow_agg

--- Tables
---		No new tables are created in this script.  Additional columns are added to the flow features table generated in 
---		script 10b.  The aggregation scheme from 15min to 1 hour is specified in the column name

alter table $features_schema.$features_segment_table
	-- features that maximize/minimize past hour's data
	ADD COLUMN speed_maxdiffxlanes_avgxseg_1hrmax15min_num decimal,
	ADD COLUMN speed_maxdiffxlanes_maxxseg_1hrmax15min_num decimal,
	ADD COLUMN speed_avgxlanes_diffloopahead_avgxseg_1hrmax15min_num decimal,
	ADD COLUMN speed_avgxlanes_diffloopbehind_avgxseg_1hrmax15min_num decimal,
	ADD COLUMN speed_avgxlanes_diffloopahead_maxxseg_1hrmax15min_num decimal,
	ADD COLUMN speed_avgxlanes_diffloopbehind_maxxseg_1hrmax15min_num decimal,
	ADD COLUMN speed_avgxlanes_diffprevrec_avgxseg_1hrmax15min_num decimal,
	ADD COLUMN speed_avgxlanes_diffprevrec_maxxseg_1hrmax15min_num decimal,
	ADD COLUMN speed_avgxlanes_avgxseg_1hrmax15min_num decimal,
	ADD COLUMN speed_avgxlanes_avgxseg_1hrmin15min_num decimal, -- use this feature to get speed_avgxlanes_avgxseg_maxdiffx1hr_num
	ADD COLUMN speed_avgxlanes_maxxseg_1hrmax15min_num decimal,
	ADD COLUMN speed_avgxlanes_maxxseg_1hrmin15min_num decimal,  -- use this feature to get speed_avgxlanes_maxxseg_maxdiffx1hr_num
	ADD COLUMN speed_minxlanes_minxseg_1hrmin15min_num decimal,
	ADD COLUMN speed_minxlanes_avgxseg_1hrmin15min_num decimal,
	ADD COLUMN flow_maxdiffxlanes_avgxseg_1hrmax15min_num decimal,
	ADD COLUMN flow_maxdiffxlanes_maxxseg_1hrmax15min_num decimal,
	ADD COLUMN flow_totalxlanes_diffloopahead_avgxseg_1hrmax15min_num decimal,
	ADD COLUMN flow_totalxlanes_diffloopbehind_avgxseg_1hrmax15min_num decimal,
	ADD COLUMN flow_totalxlanes_diffloopahead_maxxseg_1hrmax15min_num decimal,
	ADD COLUMN flow_totalxlanes_diffloopbehind_maxxseg_1hrmax15min_num decimal,
	ADD COLUMN flow_totalxlanes_diffprevrec_avgxseg_1hrmax15min_num decimal,
	ADD COLUMN flow_totalxlanes_diffprevrec_maxxseg_1hrmax15min_num decimal,
	ADD COLUMN flow_avgxlanes_avgxseg_1hrmax15min_num decimal,
	ADD COLUMN flow_avgxlanes_maxxseg_1hrmax15min_num decimal,
	ADD COLUMN flow_avgxlanes_minxseg_1hrmin15min_num decimal,
	ADD COLUMN flow_totalxlanes_totalxseg_1hrmax15min_num decimal,
	ADD COLUMN flow_totalxlanes_totalxseg_1hrmin15min_num decimal, -- use this feature to get flow_totalxlanes_totalxseg_maxdiff1hr_num
	ADD COLUMN speedstd_avgxlanes_avgxseg_1hrmax15min_num decimal,
	ADD COLUMN speedstd_avgxlanes_maxxseg_1hrmax15min_num decimal,
	ADD COLUMN speedstd_maxxlanes_maxxseg_1hrmax15min_num decimal,
	ADD COLUMN flowstd_avgxlanes_avgxseg_1hrmax15min_num decimal,
	ADD COLUMN flowstd_avgxlanes_maxxseg_1hrmax15min_num decimal,
	ADD COLUMN flowstd_maxxlanes_maxxseg_1hrmax15min_num decimal,
	ADD COLUMN speed_avgxlanes_maxdiffxseg_1hrmax15min_num decimal,
	ADD COLUMN flow_totalxlanes_maxdiffxseg_1hrmax15min_num decimal,
	-- features that average past hour's data
	ADD COLUMN speed_maxdiffxlanes_avgxseg_1hravg15min_num decimal,
	ADD COLUMN speed_maxdiffxlanes_maxxseg_1hravg15min_num decimal,
	ADD COLUMN speed_avgxlanes_diffloopahead_avgxseg_1hravg15min_num decimal,
	ADD COLUMN speed_avgxlanes_diffloopbehind_avgxseg_1hravg15min_num decimal,
	ADD COLUMN speed_avgxlanes_diffloopahead_maxxseg_1hravg15min_num decimal,
	ADD COLUMN speed_avgxlanes_diffloopbehind_maxxseg_1hravg15min_num decimal,
	ADD COLUMN speed_avgxlanes_diffprevrec_avgxseg_1hravg15min_num decimal,
	ADD COLUMN speed_avgxlanes_diffprevrec_maxxseg_1hravg15min_num decimal,
	ADD COLUMN speed_avgxlanes_avgxseg_1hravg15min_num decimal,
	ADD COLUMN speed_avgxlanes_maxxseg_1hravg15min_num decimal,
	ADD COLUMN speed_avgxlanes_minxseg_1hravg15min_num decimal, 
	ADD COLUMN speed_minxlanes_minxseg_1hravg15min_num decimal,
	ADD COLUMN speed_minxlanes_avgxseg_1hravg15min_num decimal,
	ADD COLUMN flow_maxdiffxlanes_avgxseg_1hravg15min_num decimal,
	ADD COLUMN flow_maxdiffxlanes_maxxseg_1hravg15min_num decimal,
	ADD COLUMN flow_totalxlanes_diffloopahead_avgxseg_1hravg15min_num decimal,
	ADD COLUMN flow_totalxlanes_diffloopbehind_avgxseg_1hravg15min_num decimal,
	ADD COLUMN flow_totalxlanes_diffloopahead_maxxseg_1hravg15min_num decimal,
	ADD COLUMN flow_totalxlanes_diffloopbehind_maxxseg_1hravg15min_num decimal,
	ADD COLUMN flow_totalxlanes_diffprevrec_avgxseg_1hravg15min_num decimal,
	ADD COLUMN flow_totalxlanes_diffprevrec_maxxseg_1hravg15min_num decimal,
	ADD COLUMN flow_avgxlanes_avgxseg_1hravg15min_num decimal,
	ADD COLUMN flow_avgxlanes_maxxseg_1hravg15min_num decimal,
	ADD COLUMN flow_avgxlanes_minxseg_1hravg15min_num decimal,
	ADD COLUMN flow_totalxlanes_totalxseg_1hravg15min_num decimal,
	ADD COLUMN speedstd_avgxlanes_avgxseg_1hravg15min_num decimal,
	ADD COLUMN speedstd_avgxlanes_maxxseg_1hravg15min_num decimal,
	ADD COLUMN speedstd_maxxlanes_maxxseg_1hravg15min_num decimal,
	ADD COLUMN flowstd_avgxlanes_avgxseg_1hravg15min_num decimal,
	ADD COLUMN flowstd_avgxlanes_maxxseg_1hravg15min_num decimal,
	ADD COLUMN flowstd_maxxlanes_maxxseg_1hravg15min_num decimal,
	ADD COLUMN speed_avgxlanes_maxdiffxseg_1hravg15min_num decimal,
	ADD COLUMN flow_totalxlanes_maxdiffxseg_1hravg15min_num decimal;


WITH agg_time AS (
	SELECT
    hectokey_merged,
    end_datetime, 
	max(speed_maxdiffxlanes_avgxseg_15min_num) OVER w AS speed_maxdiffxlanes_avgxseg_1hrmax15min_num,
	max(speed_maxdiffxlanes_maxxseg_15min_num) OVER w AS speed_maxdiffxlanes_maxxseg_1hrmax15min_num,
	max(speed_avgxlanes_diffloopahead_avgxseg_15min_num) OVER w AS speed_avgxlanes_diffloopahead_avgxseg_1hrmax15min_num,
	max(speed_avgxlanes_diffloopbehind_avgxseg_15min_num) OVER w AS speed_avgxlanes_diffloopbehind_avgxseg_1hrmax15min_num,
	max(speed_avgxlanes_diffloopahead_maxxseg_15min_num) OVER w AS speed_avgxlanes_diffloopahead_maxxseg_1hrmax15min_num,
	max(speed_avgxlanes_diffloopbehind_maxxseg_15min_num) OVER w AS speed_avgxlanes_diffloopbehind_maxxseg_1hrmax15min_num,
	max(speed_avgxlanes_diffprevrec_avgxseg_15min_num) OVER w AS speed_avgxlanes_diffprevrec_avgxseg_1hrmax15min_num,
	max(speed_avgxlanes_diffprevrec_maxxseg_15min_num) OVER w AS speed_avgxlanes_diffprevrec_maxxseg_1hrmax15min_num,
	max(speed_avgxlanes_avgxseg_15min_num) OVER w AS speed_avgxlanes_avgxseg_1hrmax15min_num,
	max(speed_avgxlanes_avgxseg_15min_num) OVER w AS speed_avgxlanes_avgxseg_1hrmin15min_num,
	max(speed_avgxlanes_maxxseg_15min_num) OVER w AS speed_avgxlanes_maxxseg_1hrmax15min_num,
	min(speed_avgxlanes_maxxseg_15min_num) OVER w AS speed_avgxlanes_maxxseg_1hrmin15min_num,  
	min(speed_minxlanes_minxseg_15min_num) OVER w AS speed_minxlanes_minxseg_1hrmin15min_num,
	min(speed_minxlanes_avgxseg_15min_num) OVER w AS speed_minxlanes_avgxseg_1hrmin15min_num,
	max(flow_maxdiffxlanes_avgxseg_15min_num) OVER w AS flow_maxdiffxlanes_avgxseg_1hrmax15min_num,
	max(flow_maxdiffxlanes_maxxseg_15min_num) OVER w AS flow_maxdiffxlanes_maxxseg_1hrmax15min_num,
	max(flow_totalxlanes_diffloopahead_avgxseg_15min_num) OVER w AS flow_totalxlanes_diffloopahead_avgxseg_1hrmax15min_num,
	max(flow_totalxlanes_diffloopbehind_avgxseg_15min_num) OVER w AS flow_totalxlanes_diffloopbehind_avgxseg_1hrmax15min_num,
	max(flow_totalxlanes_diffloopahead_maxxseg_15min_num) OVER w AS flow_totalxlanes_diffloopahead_maxxseg_1hrmax15min_num,
	max(flow_totalxlanes_diffloopbehind_maxxseg_15min_num) OVER w AS flow_totalxlanes_diffloopbehind_maxxseg_1hrmax15min_num,
	max(flow_totalxlanes_diffprevrec_avgxseg_15min_num) OVER w AS flow_totalxlanes_diffprevrec_avgxseg_1hrmax15min_num,
	max(flow_totalxlanes_diffprevrec_maxxseg_15min_num) OVER w AS flow_totalxlanes_diffprevrec_maxxseg_1hrmax15min_num,
	max(flow_avgxlanes_avgxseg_15min_num) OVER w AS flow_avgxlanes_avgxseg_1hrmax15min_num,
	max(flow_avgxlanes_maxxseg_15min_num) OVER w AS flow_avgxlanes_maxxseg_1hrmax15min_num,
	min(flow_avgxlanes_minxseg_15min_num) OVER w AS flow_avgxlanes_minxseg_1hrmin15min_num,
	max(flow_totalxlanes_totalxseg_15min_num) OVER w AS flow_totalxlanes_totalxseg_1hrmax15min_num,
	min(flow_totalxlanes_totalxseg_15min_num) OVER w AS flow_totalxlanes_totalxseg_1hrmin15min_num, 
	max(speedstd_avgxlanes_avgxseg_15min_num) OVER w AS speedstd_avgxlanes_avgxseg_1hrmax15min_num,
	max(speedstd_avgxlanes_maxxseg_15min_num) OVER w AS speedstd_avgxlanes_maxxseg_1hrmax15min_num,
	max(speedstd_maxxlanes_maxxseg_15min_num) OVER w AS speedstd_maxxlanes_maxxseg_1hrmax15min_num,
	max(flowstd_avgxlanes_avgxseg_15min_num) OVER w AS flowstd_avgxlanes_avgxseg_1hrmax15min_num,
	max(flowstd_avgxlanes_maxxseg_15min_num) OVER w AS flowstd_avgxlanes_maxxseg_1hrmax15min_num,
	max(flowstd_maxxlanes_maxxseg_15min_num) OVER w AS flowstd_maxxlanes_maxxseg_1hrmax15min_num,
	max(speed_avgxlanes_maxdiffxseg_15min_num) OVER w AS speed_avgxlanes_maxdiffxseg_1hrmax15min_num,
	max(flow_totalxlanes_maxdiffxseg_15min_num) OVER w AS flow_totalxlanes_maxdiffxseg_1hrmax15min_num,
	-- features that average past hour's data
	avg(speed_maxdiffxlanes_avgxseg_15min_num) OVER w AS speed_maxdiffxlanes_avgxseg_1hravg15min_num,
	avg(speed_maxdiffxlanes_maxxseg_15min_num) OVER w AS speed_maxdiffxlanes_maxxseg_1hravg15min_num,
	avg(speed_avgxlanes_diffloopahead_avgxseg_15min_num) OVER w AS speed_avgxlanes_diffloopahead_avgxseg_1hravg15min_num,
	avg(speed_avgxlanes_diffloopbehind_avgxseg_15min_num) OVER w AS speed_avgxlanes_diffloopbehind_avgxseg_1hravg15min_num,
	avg(speed_avgxlanes_diffloopahead_maxxseg_15min_num) OVER w AS speed_avgxlanes_diffloopahead_maxxseg_1hravg15min_num,
	avg(speed_avgxlanes_diffloopbehind_maxxseg_15min_num) OVER w AS speed_avgxlanes_diffloopbehind_maxxseg_1hravg15min_num,
	avg(speed_avgxlanes_diffprevrec_avgxseg_15min_num) OVER w AS speed_avgxlanes_diffprevrec_avgxseg_1hravg15min_num,
	avg(speed_avgxlanes_diffprevrec_maxxseg_15min_num) OVER w AS speed_avgxlanes_diffprevrec_maxxseg_1hravg15min_num,
	avg(speed_avgxlanes_avgxseg_15min_num) OVER w AS speed_avgxlanes_avgxseg_1hravg15min_num,
	avg(speed_avgxlanes_maxxseg_15min_num) OVER w AS speed_avgxlanes_maxxseg_1hravg15min_num,
	avg(speed_avgxlanes_minxseg_15min_num) OVER w AS speed_avgxlanes_minxseg_1hravg15min_num, 
	avg(speed_minxlanes_minxseg_15min_num) OVER w AS speed_minxlanes_minxseg_1hravg15min_num,
	avg(speed_minxlanes_avgxseg_15min_num) OVER w AS speed_minxlanes_avgxseg_1hravg15min_num,
	avg(flow_maxdiffxlanes_avgxseg_15min_num) OVER w AS flow_maxdiffxlanes_avgxseg_1hravg15min_num,
	avg(flow_maxdiffxlanes_maxxseg_15min_num) OVER w AS flow_maxdiffxlanes_maxxseg_1hravg15min_num,
	avg(flow_totalxlanes_diffloopahead_avgxseg_15min_num) OVER w AS flow_totalxlanes_diffloopahead_avgxseg_1hravg15min_num,
	avg(flow_totalxlanes_diffloopbehind_avgxseg_15min_num) OVER w AS flow_totalxlanes_diffloopbehind_avgxseg_1hravg15min_num,
	avg(flow_totalxlanes_diffloopahead_maxxseg_15min_num) OVER w AS flow_totalxlanes_diffloopahead_maxxseg_1hravg15min_num,
	avg(flow_totalxlanes_diffloopbehind_maxxseg_15min_num) OVER w AS flow_totalxlanes_diffloopbehind_maxxseg_1hravg15min_num,
	avg(flow_totalxlanes_diffprevrec_avgxseg_15min_num) OVER w AS flow_totalxlanes_diffprevrec_avgxseg_1hravg15min_num,
	avg(flow_totalxlanes_diffprevrec_maxxseg_15min_num) OVER w AS flow_totalxlanes_diffprevrec_maxxseg_1hravg15min_num,
	avg(flow_avgxlanes_avgxseg_15min_num) OVER w AS flow_avgxlanes_avgxseg_1hravg15min_num,
	avg(flow_avgxlanes_maxxseg_15min_num) OVER w AS flow_avgxlanes_maxxseg_1hravg15min_num,
	avg(flow_avgxlanes_minxseg_15min_num) OVER w AS flow_avgxlanes_minxseg_1hravg15min_num,
	avg(flow_totalxlanes_totalxseg_15min_num) OVER w AS flow_totalxlanes_totalxseg_1hravg15min_num,
	avg(speedstd_avgxlanes_avgxseg_15min_num) OVER w AS speedstd_avgxlanes_avgxseg_1hravg15min_num,
	avg(speedstd_avgxlanes_maxxseg_15min_num) OVER w AS speedstd_avgxlanes_maxxseg_1hravg15min_num,
	avg(speedstd_maxxlanes_maxxseg_15min_num) OVER w AS speedstd_maxxlanes_maxxseg_1hravg15min_num,
	avg(flowstd_avgxlanes_avgxseg_15min_num) OVER w AS flowstd_avgxlanes_avgxseg_1hravg15min_num,
	avg(flowstd_avgxlanes_maxxseg_15min_num) OVER w AS flowstd_avgxlanes_maxxseg_1hravg15min_num,
	avg(flowstd_maxxlanes_maxxseg_15min_num) OVER w AS flowstd_maxxlanes_maxxseg_1hravg15min_num,
	avg(speed_avgxlanes_maxdiffxseg_15min_num) OVER w AS speed_avgxlanes_maxdiffxseg_1hravg15min_num,
	avg(flow_totalxlanes_maxdiffxseg_15min_num) OVER w AS flow_totalxlanes_maxdiffxseg_1hravg15min_num
	FROM $features_schema.$features_segment_table
	WINDOW w AS (PARTITION BY hectokey_merged ORDER BY end_datetime asc rows BETWEEN 3 PRECEDING AND CURRENT ROW)
)
UPDATE $features_schema.$features_segment_table AS s
SET 
	speed_maxdiffxlanes_avgxseg_1hrmax15min_num = a.speed_maxdiffxlanes_avgxseg_1hrmax15min_num,
	speed_maxdiffxlanes_maxxseg_1hrmax15min_num = a.speed_maxdiffxlanes_maxxseg_1hrmax15min_num,
	speed_avgxlanes_diffloopahead_avgxseg_1hrmax15min_num = a.speed_avgxlanes_diffloopahead_avgxseg_1hrmax15min_num,
	speed_avgxlanes_diffloopbehind_avgxseg_1hrmax15min_num = a.speed_avgxlanes_diffloopbehind_avgxseg_1hrmax15min_num,
	speed_avgxlanes_diffloopahead_maxxseg_1hrmax15min_num = a.speed_avgxlanes_diffloopahead_maxxseg_1hrmax15min_num,
	speed_avgxlanes_diffloopbehind_maxxseg_1hrmax15min_num = a.speed_avgxlanes_diffloopbehind_maxxseg_1hrmax15min_num,
	speed_avgxlanes_diffprevrec_avgxseg_1hrmax15min_num = a.speed_avgxlanes_diffprevrec_avgxseg_1hrmax15min_num,
	speed_avgxlanes_diffprevrec_maxxseg_1hrmax15min_num = a.speed_avgxlanes_diffprevrec_maxxseg_1hrmax15min_num,
	speed_avgxlanes_avgxseg_1hrmax15min_num = a.speed_avgxlanes_avgxseg_1hrmax15min_num,
	speed_avgxlanes_avgxseg_1hrmin15min_num = a.speed_avgxlanes_avgxseg_1hrmin15min_num,
	speed_avgxlanes_maxxseg_1hrmax15min_num = a.speed_avgxlanes_maxxseg_1hrmax15min_num,
	speed_avgxlanes_maxxseg_1hrmin15min_num = a.speed_avgxlanes_maxxseg_1hrmin15min_num,  
	speed_minxlanes_minxseg_1hrmin15min_num = a.speed_minxlanes_minxseg_1hrmin15min_num,
	speed_minxlanes_avgxseg_1hrmin15min_num = a.speed_minxlanes_avgxseg_1hrmin15min_num,
	flow_maxdiffxlanes_avgxseg_1hrmax15min_num = a.flow_maxdiffxlanes_avgxseg_1hrmax15min_num,
	flow_maxdiffxlanes_maxxseg_1hrmax15min_num = a.flow_maxdiffxlanes_maxxseg_1hrmax15min_num,
	flow_totalxlanes_diffloopahead_avgxseg_1hrmax15min_num = a.flow_totalxlanes_diffloopahead_avgxseg_1hrmax15min_num,
	flow_totalxlanes_diffloopbehind_avgxseg_1hrmax15min_num = a.flow_totalxlanes_diffloopbehind_avgxseg_1hrmax15min_num,
	flow_totalxlanes_diffloopahead_maxxseg_1hrmax15min_num = a.flow_totalxlanes_diffloopahead_maxxseg_1hrmax15min_num,
	flow_totalxlanes_diffloopbehind_maxxseg_1hrmax15min_num = a.flow_totalxlanes_diffloopbehind_maxxseg_1hrmax15min_num,
	flow_totalxlanes_diffprevrec_avgxseg_1hrmax15min_num = a.flow_totalxlanes_diffprevrec_avgxseg_1hrmax15min_num,
	flow_totalxlanes_diffprevrec_maxxseg_1hrmax15min_num = a.flow_totalxlanes_diffprevrec_maxxseg_1hrmax15min_num,
	flow_avgxlanes_avgxseg_1hrmax15min_num = a.flow_avgxlanes_avgxseg_1hrmax15min_num,
	flow_avgxlanes_maxxseg_1hrmax15min_num = a.flow_avgxlanes_maxxseg_1hrmax15min_num,
	flow_avgxlanes_minxseg_1hrmin15min_num = a.flow_avgxlanes_minxseg_1hrmin15min_num,
	flow_totalxlanes_totalxseg_1hrmax15min_num = a.flow_totalxlanes_totalxseg_1hrmax15min_num,
	flow_totalxlanes_totalxseg_1hrmin15min_num = a.flow_totalxlanes_totalxseg_1hrmin15min_num, 
	speedstd_avgxlanes_avgxseg_1hrmax15min_num = a.speedstd_avgxlanes_avgxseg_1hrmax15min_num,
	speedstd_avgxlanes_maxxseg_1hrmax15min_num = a.speedstd_avgxlanes_maxxseg_1hrmax15min_num,
	speedstd_maxxlanes_maxxseg_1hrmax15min_num = a.speedstd_maxxlanes_maxxseg_1hrmax15min_num,
	flowstd_avgxlanes_avgxseg_1hrmax15min_num = a.flowstd_avgxlanes_avgxseg_1hrmax15min_num,
	flowstd_avgxlanes_maxxseg_1hrmax15min_num = a.flowstd_avgxlanes_maxxseg_1hrmax15min_num,
	flowstd_maxxlanes_maxxseg_1hrmax15min_num = a.flowstd_maxxlanes_maxxseg_1hrmax15min_num,
	speed_avgxlanes_maxdiffxseg_1hrmax15min_num = a.speed_avgxlanes_maxdiffxseg_1hrmax15min_num,
	flow_totalxlanes_maxdiffxseg_1hrmax15min_num = a.flow_totalxlanes_maxdiffxseg_1hrmax15min_num,
	-- features that average past hour's data
	speed_maxdiffxlanes_avgxseg_1hravg15min_num = a.speed_maxdiffxlanes_avgxseg_1hravg15min_num,
	speed_maxdiffxlanes_maxxseg_1hravg15min_num = a.speed_maxdiffxlanes_maxxseg_1hravg15min_num,
	speed_avgxlanes_diffloopahead_avgxseg_1hravg15min_num = a.speed_avgxlanes_diffloopahead_avgxseg_1hravg15min_num,
	speed_avgxlanes_diffloopbehind_avgxseg_1hravg15min_num = a.speed_avgxlanes_diffloopbehind_avgxseg_1hravg15min_num,
	speed_avgxlanes_diffloopahead_maxxseg_1hravg15min_num = a.speed_avgxlanes_diffloopahead_maxxseg_1hravg15min_num,
	speed_avgxlanes_diffloopbehind_maxxseg_1hravg15min_num = a.speed_avgxlanes_diffloopbehind_maxxseg_1hravg15min_num,
	speed_avgxlanes_diffprevrec_avgxseg_1hravg15min_num = a.speed_avgxlanes_diffprevrec_avgxseg_1hravg15min_num,
	speed_avgxlanes_diffprevrec_maxxseg_1hravg15min_num = a.speed_avgxlanes_diffprevrec_maxxseg_1hravg15min_num,
	speed_avgxlanes_avgxseg_1hravg15min_num = a.speed_avgxlanes_avgxseg_1hravg15min_num,
	speed_avgxlanes_maxxseg_1hravg15min_num = a.speed_avgxlanes_maxxseg_1hravg15min_num,
	speed_avgxlanes_minxseg_1hravg15min_num = a.speed_avgxlanes_minxseg_1hravg15min_num, 
	speed_minxlanes_minxseg_1hravg15min_num = a.speed_minxlanes_minxseg_1hravg15min_num,
	speed_minxlanes_avgxseg_1hravg15min_num = a.speed_minxlanes_avgxseg_1hravg15min_num,
	flow_maxdiffxlanes_avgxseg_1hravg15min_num = a.flow_maxdiffxlanes_avgxseg_1hravg15min_num,
	flow_maxdiffxlanes_maxxseg_1hravg15min_num = a.flow_maxdiffxlanes_maxxseg_1hravg15min_num,
	flow_totalxlanes_diffloopahead_avgxseg_1hravg15min_num = a.flow_totalxlanes_diffloopahead_avgxseg_1hravg15min_num,
	flow_totalxlanes_diffloopbehind_avgxseg_1hravg15min_num = a.flow_totalxlanes_diffloopbehind_avgxseg_1hravg15min_num,
	flow_totalxlanes_diffloopahead_maxxseg_1hravg15min_num = a.flow_totalxlanes_diffloopahead_maxxseg_1hravg15min_num,
	flow_totalxlanes_diffloopbehind_maxxseg_1hravg15min_num = a.flow_totalxlanes_diffloopbehind_maxxseg_1hravg15min_num,
	flow_totalxlanes_diffprevrec_avgxseg_1hravg15min_num = a.flow_totalxlanes_diffprevrec_avgxseg_1hravg15min_num,
	flow_totalxlanes_diffprevrec_maxxseg_1hravg15min_num = a.flow_totalxlanes_diffprevrec_maxxseg_1hravg15min_num,
	flow_avgxlanes_avgxseg_1hravg15min_num = a.flow_avgxlanes_avgxseg_1hravg15min_num,
	flow_avgxlanes_maxxseg_1hravg15min_num = a.flow_avgxlanes_maxxseg_1hravg15min_num,
	flow_avgxlanes_minxseg_1hravg15min_num = a.flow_avgxlanes_minxseg_1hravg15min_num,
	flow_totalxlanes_totalxseg_1hravg15min_num = a.flow_totalxlanes_totalxseg_1hravg15min_num,
	speedstd_avgxlanes_avgxseg_1hravg15min_num = a.speedstd_avgxlanes_avgxseg_1hravg15min_num,
	speedstd_avgxlanes_maxxseg_1hravg15min_num = a.speedstd_avgxlanes_maxxseg_1hravg15min_num,
	speedstd_maxxlanes_maxxseg_1hravg15min_num = a.speedstd_maxxlanes_maxxseg_1hravg15min_num,
	flowstd_avgxlanes_avgxseg_1hravg15min_num = a.flowstd_avgxlanes_avgxseg_1hravg15min_num,
	flowstd_avgxlanes_maxxseg_1hravg15min_num = a.flowstd_avgxlanes_maxxseg_1hravg15min_num,
	flowstd_maxxlanes_maxxseg_1hravg15min_num = a.flowstd_maxxlanes_maxxseg_1hravg15min_num,
	speed_avgxlanes_maxdiffxseg_1hravg15min_num = a.speed_avgxlanes_maxdiffxseg_1hravg15min_num,
	flow_totalxlanes_maxdiffxseg_1hravg15min_num = a.flow_totalxlanes_maxdiffxseg_1hravg15min_num
FROM agg_time AS a
WHERE s.hectokey_merged = a.hectokey_merged AND 
s.end_datetime = a.end_datetime; 





--update to add features related to difference across time
ALTER table $features_schema.$features_segment_table
ADD COLUMN  speed_avgxlanes_avgxseg_maxdiffx1hr_num decimal,
ADD COLUMN  speed_avgxlanes_maxxseg_maxdiffx1hr_num decimal,
ADD COLUMN flow_totalxlanes_totalxseg_maxdiffx1hr_num decimal;


UPDATE $features_schema.$features_segment_table
SET speed_avgxlanes_avgxseg_maxdiffx1hr_num = speed_avgxlanes_avgxseg_1hrmax15min_num - speed_avgxlanes_avgxseg_1hrmin15min_num,
speed_avgxlanes_maxxseg_maxdiffx1hr_num = speed_avgxlanes_maxxseg_1hrmax15min_num - speed_avgxlanes_maxxseg_1hrmin15min_num,
flow_totalxlanes_totalxseg_maxdiffx1hr_num = flow_totalxlanes_totalxseg_1hrmax15min_num - flow_totalxlanes_totalxseg_1hrmin15min_num;

